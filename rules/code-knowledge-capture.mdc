---
description: Capture code understanding and feature knowledge to accelerate future sessions
alwaysApply: true
---

# Code Knowledge Capture

When you spend significant effort understanding how something works in the codebase, **you MUST document it** so future sessions don't repeat that work.

## Triggers for Knowledge Capture

Document when you:
- Read more than 5 files to understand a feature
- Trace a flow through multiple layers (API → service → repository → DB)
- Figure out how a business process works (reschedules, upgrades, payments, etc.)
- Discover non-obvious relationships between components
- Identify entry points for specific operations
- Learn domain terminology specific to the project

## Knowledge Types & Templates

### 1. Feature Flows (`.git/local-context/flows/`)

When you understand how a feature/process works end-to-end:

```bash
mkdir -p .git/local-context/flows
cat > .git/local-context/flows/<feature-name>.md << 'EOF'
# <Feature Name> Flow

## Summary
<1-2 sentence description of what this feature does>

## Entry Points
- API: `<path/to/controller.py>` → `<function_name>()`
- CLI: `<command if applicable>`
- Event: `<event name if triggered by events>`

## Key Files
| File | Purpose |
|------|---------|
| `path/to/file1.py` | <what it does> |
| `path/to/file2.py` | <what it does> |

## Flow Sequence
1. <Step 1: what happens, where>
2. <Step 2: what happens, where>
3. <Step 3: ...>

## Domain Concepts
- **<Term>**: <definition in this context>

## Gotchas / Non-obvious Behavior
- <anything surprising or easy to miss>

## Related Features
- <other features that interact with this one>
EOF
```

### 2. Code Map (`.git/local-context/code-map.md`)

High-level map of the codebase structure:

```bash
cat >> .git/local-context/code-map.md << 'EOF'

## <Area Name>

**Location:** `src/<path>/`
**Purpose:** <what this area handles>
**Key files:**
- `file1.py` - <purpose>
- `file2.py` - <purpose>

**Depends on:** <other areas>
**Used by:** <what uses this>
EOF
```

### 3. Domain Glossary (`.git/local-context/glossary.md`)

Project-specific terminology:

```bash
cat >> .git/local-context/glossary.md << 'EOF'

### <Term>
**Definition:** <what it means in this project>
**Examples:** <concrete examples>
**See also:** <related terms or files>
EOF
```

### 4. Entry Points Index (`.git/local-context/entry-points.md`)

Quick reference for common operations:

```bash
cat >> .git/local-context/entry-points.md << 'EOF'

## <Operation Name>
**To understand:** Start at `<file:function>`
**To modify:** Look at `<file>`
**Tests:** `<test file or command>`
**Related flows:** <link to flow doc>
EOF
```

### 5. Questions & Answers (`.git/local-context/qa.md`)

Cache of answered questions about the codebase:

```bash
cat >> .git/local-context/qa.md << 'EOF'

## Q: <Question that was asked/investigated>
**A:** <Answer discovered>
**Evidence:** `<file:line>` - <what confirmed this>
**Date:** <when discovered>
EOF
```

## When to Create Each Type

| Situation | Create |
|-----------|--------|
| Traced a user action through the code | Flow document |
| Explored a new area of codebase | Code map entry |
| Learned what a domain term means | Glossary entry |
| Found where to start for a task type | Entry point |
| Answered a "how does X work?" question | Q&A entry |

## Proactive Capture

After significant code exploration, say:
> "I've documented how [feature] works in `.git/local-context/flows/[name].md` for future reference."

Before exploring code, check:
```bash
ls .git/local-context/flows/ 2>/dev/null
cat .git/local-context/entry-points.md 2>/dev/null
```

## Session Start Enhancement

When starting work, also check:
```bash
# Existing knowledge
ls .git/local-context/flows/ 2>/dev/null
test -f .git/local-context/code-map.md && echo "Code map available"
test -f .git/local-context/glossary.md && echo "Glossary available"
test -f .git/local-context/entry-points.md && echo "Entry points available"
```

If the user asks about a feature and a flow document exists, **read it first** before exploring code.

## Example: Documenting a "Reschedule" Feature

After spending time understanding rescheduling:

```bash
mkdir -p .git/local-context/flows
cat > .git/local-context/flows/reschedule.md << 'EOF'
# Reschedule Flow

## Summary
Allows users to change their booking to a different date/time slot.

## Entry Points
- API: `src/api/bookings/views.py` → `RescheduleView.post()`
- Admin: `src/admin/bookings/actions.py` → `reschedule_booking()`

## Key Files
| File | Purpose |
|------|---------|
| `src/domain/booking/reschedule.py` | Core reschedule logic |
| `src/domain/booking/validators.py` | Validates reschedule is allowed |
| `src/infrastructure/payments/refund.py` | Handles price difference |

## Flow Sequence
1. Request comes to `RescheduleView.post()` with new slot
2. `RescheduleValidator.validate()` checks eligibility
3. `RescheduleService.execute()` performs the change
4. If price differs, `PaymentService.adjust()` handles it
5. Notifications sent via `NotificationService`

## Domain Concepts
- **Reschedule window**: Time before event when reschedule is allowed
- **Slot**: A specific date/time for an experience

## Gotchas
- Reschedule might trigger partial refund if new slot is cheaper
- Some experiences don't allow reschedule (check `experience.reschedule_policy`)

## Related Features
- Cancellation (similar flow, different outcome)
- Upgrade (changes experience, not just time)
EOF
```

Then say: "I've documented the reschedule flow for future sessions."

## Maintenance

When code changes significantly:
- Update affected flow documents
- Add "[Updated]" section noting what changed
- Don't delete old info, append updates (history is valuable)
